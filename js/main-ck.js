"use strict";var PrototypeExtensions={data:function(e,t,n){var r,i,s,o,u;r=/data-(\w+)/;i=0;s=e.attributes.length;if(t&&n)e.setAttribute("data-"+t,n);else for(;i<s;++i){o=e.attributes[i];if(o&&o.name){var a=o.name.match(r);if(a&&a.length>1){u=a[1];if(u===t)return o.value}}}}};Element.addMethods(PrototypeExtensions);var sort_by=function(e,t,n){var r=n?function(t){return n(t[e])}:function(t){return t[e]};t=[-1,1][+!!t];return function(e,n){return e=r(e),n=r(n),t*((e>n)-(n>e))}},dudusLibrary=new localStorageDB("dudus",localStorage);if(dudusLibrary.isNew()){dudusLibrary.createTable("todos",["text","note","favorite","active","folder","date","weight","created","reminder"]);dudusLibrary.commit()}var dudu,DuduLists=Class.create({initialize:function(e){this.callback=[];this.formField=e;this.activeDudus=dudusLibrary.query("todos",{active:"1"});this.inactiveDudus=dudusLibrary.query("todos",{active:"0"});this.activeDudusUL=$("activeDudusUL");this.inactiveDudusUL=$("inactiveDudusUL");this.refreshLists(this.activeDudus,this.activeDudusUL);this.refreshLists(this.inactiveDudus,this.inactiveDudusUL);this.updateCompletedItemsHeader();this.fieldObserver(this.formField);this.rubberNeck()},fieldObserver:function(e){e.observe("keypress",function(e){if(e.keyCode==Event.KEY_RETURN||e.which==Event.KEY_RETURN){this.createDudu();Event.stop(e)}}.bind(this))},favoriteObserver:function(){$("activeDudusWrapper","editForm").invoke("on","click",".favoriteToggle",function(e,t){var n,r,i,s,o;i=t.up();s=this.remoteChecker(i);r=i.hasClassName("duduEdit")?s.up():i.up();n=i.hasClassName("duduEdit")?i.data("id"):i.getAttribute("id");if(i.hasClassName("unflagged")){o="1";i.removeClassName("unflagged").addClassName("flagged");t.removeClassName("glyphicon-star-empty").addClassName("glyphicon-star")}else{o="0";i.removeClassName("flagged").addClassName("unflagged");t.removeClassName("glyphicon-star").addClassName("glyphicon-star-empty")}if(s!==null)if(i.hasClassName("unflagged")){s.addClassName("unflagged").removeClassName("flagged");s.down(".glyphicon").addClassName("glyphicon-star-empty").removeClassName("glyphicon-star")}else{s.removeClassName("unflagged").addClassName("flagged");s.down(".glyphicon").removeClassName("glyphicon-star-empty").addClassName("glyphicon-star")}if(n){dudusLibrary.update("todos",{ID:n},function(e){e.favorite=o;return e});dudusLibrary.commit()}}.bind(this))},doneObserver:function(){$("duduContainer").on("click",".done",function(e,t){var n,r,i,s;i=t.up();s=this.remoteChecker(i);r=i.hasClassName("duduEdit")?s.up():i.up();n=i.hasClassName("duduEdit")?i.data("id"):i.getAttribute("id");if(t.checked==1){i.removeClassName("active").addClassName("inactive");inactiveDudusUL.insert({top:r});dudusLibrary.update("todos",{ID:n},function(e){e.active="0";return e})}else{i.addClassName("active").removeClassName("inactive");activeDudusUL.insert({bottom:r});dudusLibrary.update("todos",{ID:n},function(e){e.active="1";return e})}dudusLibrary.commit();if(s!==null)if(t.checked==1)if(s.hasClassName("duduEdit")){s.down(".done").checked=!0;t.next("span",1).addClassName("disabled");i.down(".glyphicon").removeClassName("favoriteToggle")}else{s.removeClassName("active").addClassName("inactive");s.down(".done").checked=!0}else if(s.hasClassName("duduEdit")){$(n+"_editing").removeClassName("inactive").addClassName("active");s.down(".done").checked=!1;t.next("span",1).removeClassName("disabled");i.down(".glyphicon").addClassName("favoriteToggle")}else{s.addClassName("active").removeClassName("inactive");s.down(".done").checked=!1}this.updateCompletedItemsHeader()}.bind(this))},updateCompletedItemsHeader:function(){var e=$$("#inactiveDudusUL li").length,t=e>1?"s":"";e>0?$("completedDudus").update(e+" Completed Item"+t):$("completedDudus").update("")},createDudu:function(){var e,t,n,r,i;e=this.formField.getValue();t=$("favoriteToggle").data("favorite");i=this.formField.up().hasClassName("unflagged")?"unflagged":"flagged";n=t==0?"-empty":"";r=dudusLibrary.insert("todos",{text:e,note:"",favorite:t,active:"1",folder:"default",date:"",weight:"0",created:Date.now(),reminder:""});dudusLibrary.commit();activeDudusUL.insert({top:'<li data-id="'+r+'" class="active list-group-item"><div id="'+r+'" class="duduItem active '+i+'"><input class="done" type="checkbox" value="1">'+e+'<span class="glyphicon glyphicon-star'+n+' pull-right star favoriteToggle" data-favorite="'+t+'"></span></div></li>'});this.formField.clear()},deleteDudu:function(e,t){Modalbox.show($("confirmDelete"),{title:"Really delete "+t+"?",width:400,slideDownDuration:.1,slideUpDuration:.2,afterLoad:function(t){$("deleteDudu").observe("click",function(t){dudusLibrary.deleteRows("todos",{ID:e});dudusLibrary.commit();Modalbox.hide();$("collapseMe").removeClassName("col-md-4").addClassName("col-md-9");$("editForm").hide();$("editing").remove()})}})},refreshLists:function(e,t){if(e){var n,r,i,s,o,u;n=e.sort(sort_by("weight",!1,parseInt));n.each(function(e){r=e.favorite==0?"-empty":"";u=e.favorite==0?"unflagged":"flagged";i=e.active==0?"checked":"";s=e.active==0?"inactive ":"active ";o=typeof e.note=="undefined"?"":'<span class="glyphicon glyphicon-pencil"></span>';t.insert({top:'<li data-ID="'+e.ID+'" class="'+s+'list-group-item"><div id="'+e.ID+'" class="duduItem '+u+" "+s+'"><input class="done" type="checkbox" value="1" '+i+">"+e.text+o+'<span class="glyphicon glyphicon-star'+r+' pull-right duduItem star favoriteToggle" data-favorite="'+e.favorite+'"></span></div></li>'})})}},rubberNeck:function(){this.favoriteObserver();this.doneObserver();this.editObserver()},remoteChecker:function(e){var t,n;n=null;if(e.hasClassName("duduEdit")){t=e.data("id");n=$(t)}else{t=e.getAttribute("id");$(t+"_editing")!==null&&t==$(t+"_editing").data("id")&&(n=$(t+"_editing"))}return n},editObserver:function(){$("collapseMe").on("dblclick","li",function(e,t){var n,r,i;if($("collapseMe").hasClassName("col-md-8")){$("collapseMe").removeClassName("col-md-8").addClassName("col-md-4");$("editForm").show();n=t.data("id");r=dudusLibrary.query("todos",{ID:n});r=r[0];this.populateEditForm(r);$("closeForm").observe("click",function(){t.removeAttribute("id");$("collapseMe").removeClassName("col-md-4").addClassName("col-md-8");$("editForm").hide()})}}.bind(this))},populateEditForm:function(e){var t,n,r,i,s,o;t=e.favorite==0?"-empty":"";n=e.active==0?"checked":"";r=e.active==0?"inactive ":"active ";i=e.ID;s=new Template('<div class="'+r+'panel panel-default"><div class="panel-heading"><h3 class="panel-title""><div data-id="#{ID}" id="'+i+'_editing" class="duduEdit duduItem '+r+'"><input class="done" type="checkbox" value="1" '+n+'>&nbsp;&nbsp;<span class="editable" data-attribute="text, #{ID}">#{text}</span><span class="glyphicon glyphicon-star'+t+' pull-right duduItem star favoriteToggle" data-favorite="'+e.favorite+'"></span></div></h3></div><ul class="list-group"><li class="list-group-item"><h6>Note:</h6><div class="note editable" data-type="textarea" data-attribute="note, #{ID}">#{note}</div></li></ul><div class="panel-footer text-center"><span class="glyphicon glyphicon-trash pull-left"></span><small>Created '+moment(e.created).format("ddd, MMMM Do")+'</small> <span id="closeForm" class="glyphicon glyphicon-expand pull-right"></span></div></div>');o=s.evaluate(e);$("editForm").update(o);$j(".editable").jinplace({placeholder:"Click to edit",submitFunction:function(e,t){var n,r,i,s,o,u;n=e.attribute.split(",");r=parseInt(n[1]);i=n[0];s=$j("#"+r);u=$j(s).find(".glyphicon").hasClassName("glyphicon-pencil")?!0:!1;o='<span class="glyphicon glyphicon-pencil"></span>';console.log(s);dudusLibrary.update("todos",{ID:r},function(e){switch(i){case"text":e.text=t;break;case"note":e.note=t;t&&!u&&$j(s).append(o);!t&&u&&$j(s).find("div.glyphicon-pencil").remove()}return e});dudusLibrary.commit();return t}});$("editForm").down(".glyphicon-trash").observe("click",function(t){this.deleteDudu(i,e.text)}.bind(this))}});Event.observe(window,"load",function(){dudu=new DuduLists($("duduItem"))}.bind(window));